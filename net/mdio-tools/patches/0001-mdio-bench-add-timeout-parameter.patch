From 211a22485715dbeb2c6add48a34c1b079945762a Mon Sep 17 00:00:00 2001
From: Aleksander Jan Bajkowski <olek2@wp.pl>
Date: Sun, 7 Sep 2025 18:20:18 +0200
Subject: [PATCH] mdio: bench: add timeout parameter

Signed-off-by: Aleksander Jan Bajkowski <olek2@wp.pl>
---
 src/mdio/main.c | 2 +-
 src/mdio/mdio.c | 3 ++-
 2 files changed, 3 insertions(+), 2 deletions(-)

diff --git a/src/mdio/main.c b/src/mdio/main.c
index 0ddd381..fbc63fe 100644
--- a/src/mdio/main.c
+++ b/src/mdio/main.c
@@ -65,7 +65,7 @@ int usage(int rc, FILE *fp)
 	      "    DATA: u16\n"
 	      "    MASK: u16\n"
 	      "\n"
- 	      "  bench REG [DATA]\n"
+	      "  bench REG [DATA] [timeout TIMEOUT]\n"
 	      "    Benchmark read performance. If DATA is supplied, it is written to REG,\n"
 	      "    otherwise the current value in REG is read. REG is then read 1000\n"
 	      "    times. Any unexpected values are reported, along with the total time.\n"
diff --git a/src/mdio/mdio.c b/src/mdio/mdio.c
index 4677db6..a36ba4a 100644
--- a/src/mdio/mdio.c
+++ b/src/mdio/mdio.c
@@ -440,6 +440,7 @@ int mdio_common_bench_exec(struct mdio_device *dev, int argc, char **argv)
 	struct mdio_prog prog = MDIO_PROG_EMPTY;
 	struct timespec start;
 	uint32_t reg, val = 0;
+	unsigned int timeout = 100;
 	int err, loop;
 
 	err = mdio_device_parse_reg(dev, &argc, &argv, &reg, NULL);
@@ -483,7 +484,7 @@ int mdio_common_bench_exec(struct mdio_device *dev, int argc, char **argv)
 	mdio_prog_push(&prog, INSN(JNE, REG(6), IMM(1000), GOTO(prog.len, loop)));
 
 	clock_gettime(CLOCK_MONOTONIC, &start);
-	err = mdio_xfer_timeout(dev->bus, &prog, mdio_common_bench_cb, &start, 10000);
+	err = mdio_xfer_timeout(dev->bus, &prog, mdio_common_bench_cb, &start, timeout * 1000);
 	free(prog.insns);
 	if (err) {
 		fprintf(stderr, "ERROR: Bench operation failed (%d)\n", err);
-- 
2.47.3

